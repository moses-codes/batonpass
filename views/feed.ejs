<%- include('partials/header') -%>

  <% let musicians=users.filter( el=> el.isOrg === false) %>
    <% let orgs=users.filter( el=> el.isOrg === true) %>
      <div class="container">
        
          <!--ENSEMBLE'S VIEW-->
          <% if (currUser.isOrg) { %>
            

              
            <h1 class="">Hello, <%= `${currUser.givenName} ${currUser.surName}`%> </h1>
            <h2>You are seen as: <%= currUser.orgName%></h2>
            <div class="row justify-content-center mt-5">
            <div class=" w-25">
            <!--Show only users that are NOT orgs.-->
            <% let connections=musicians.filter( el=> { %>
              <% return currUser.contactConfirm.indexOf(el._id)> -1 %>
                <% }) %>
                  <% let nonConnections=musicians.filter( el=> { %>
                    <% return currUser.contactConfirm.indexOf(el._id)==-1 %>
                      <% }) %>
                    <div class="connections-container">
                        <% if (connections.length){%>
                          <p class="lead">
                            You have connected with the following musicians.
                          </p>
                          <ul class="list-group">
                            <% for (let friend of currUser.contactPending) {%>
                              <% let result=users.find(el=> el._id == friend) %>
                                <% let id=result._id %>
                                  <% let name=`${result.givenName} ${result.surName}`%>
                                    <li class="list-group-item list-group-item-warning w-100 p-3">
                                      <h2>
                                        <%= name %> 
                                      </h2>
                                      <h5>wants to connect with you!</h5>
                                      <p> <%=result.summary%></p>
                                      <form class="col-1"
                                        action="/connections/confirmConnect/<%= id %>/<%= currUser._id %>/?_method=PUT"
                                        method="POST">
                                        <button class="btn btn-primary" type="submit">Accept</button>
                                      </form>
                                    </li>

                                    <%}%>
                          <% connections.forEach( connection=> { %>
                            <li class="list-group-item w-100 p-3">
                            <h2>
                              <%= `${connection.givenName} ${connection.surName}` %>
                            </h2>
                            <h3>
                              <%= `${connection.city}, ${connection.loc_state}`%>
                            </h3>
                            <h5>
                              <%= connection.summary%>
                            </h5>
                            <p>
                              <%= connection.bio%>
                            </p>
                            <p>
                              <%= connection.email %>
                            </p>
                          </li>
                            <% })%>

                          </ul>
                              <% }else{%>
                                <h4>
                                  No connections yet.
                                </h4>
                                <% } %>
                                  <!--Address pending connections-->
                                  <ul class="mx-5 border border-secondary">
                                    
                                  </ul>

                                </div>
                                </div>
                                <div class="w-75 px-5">
                                  <% if (nonConnections.length){%>
                                    <h1>
                                      Musicians available for hire
                                    </h1>
                                    <ul class="list-group">

                                      <%nonConnections.forEach( el=> {%>

                                        <li class="list-group-item <%= currUser.contactPending.indexOf(el._id) ? `` : `list-group-item-warning` %>">
                                          
                                            <h3>
                                              <%= `${el.givenName} ${el.surName}` %>
                                            </h3>
                                            <h4>
                                              <%= `${el.city}, ${el.loc_state}` %>
                                            </h4>
                                            <p>
                                              <%= el.summary %>
                                            </p>
                                            <% if (currUser.contactPending.indexOf(el._id)){ %>
                                            <form class="col-1"
                                              action="/connections/requestConnect/<%= el._id %>/<%= currUser._id %>/?_method=PUT"
                                              method="POST">
                                              <button class="btn btn-primary" type="submit">
                                                <%= el.contactPending.indexOf(currUser._id) == -1 ? 'Connect' : 'Pending Request' %>
                                              </button>
                                            </form>
                                            <%} else { %>
                                            <form class="col-1"
                                                action="/connections/confirmConnect/<%= el._id %>/<%= currUser._id %>/?_method=PUT"
                                                method="POST">
                                                <button class="btn btn-primary" type="submit">Accept</button>
                                              </form>
                                            <% }%>
                                        </li>


                                        <% }) %>
                                    </ul>
                                    <%} else {%>
                                      <h1 class="my-6">
                                        No musicians are available for hire right now. Check back later. 
                                      </h1>
                                      <% } %>
                                    </div>

                                </div>
                                      <!--MUSICIAN'S VIEW-->

                                      <%}else{%>
                                        <h3>
                                          Hi, <%= currUser.givenName %>!
                                        </h3>
                                        <span>is musician</span>

                                        <% let postsConnected=posts.filter( el=> {%>
                                          <% return currUser.contactConfirm.indexOf(el.user)> -1%>
                                            <% })%>
                                              <% let postsVirginal=posts.filter( el=> {%>
                                                <% return currUser.contactConfirm.indexOf(el.user)==-1%>
                                                  <% })%>
                                                  <div class="row justify-content-center mt-5">
                                                  <div class="p-0 w-25">
                                                    <!--Pending requests-->
                                                    <% if (currUser.contactPending.length){%>
                                                      <ul >
                                                        <% for (let friend of currUser.contactPending) {%>
                                                          <% let result=users.find(el=> el._id == friend) %>
                                                            <% let id=result._id %>
                                                              <% let name=`${result.givenName} ${result.surName}`%>
                                                                <li>
                                                                  <h2>
                                                                    <%= name %> wants to add you as a connection
                                                                  </h2>
                                                                  <form class="col-1"
                                                                    action="/connections/confirmConnect/<%= id %>/<%= currUser._id %>/?_method=PUT"
                                                                    method="POST">
                                                                    <button class="btn btn-primary"
                                                                      type="submit">Accept</button>
                                                                  </form>
                                                                </li>

                                                                <%}%>
                                                      </ul>
                                                      <%}%>

                                                        <% if (postsConnected.length) {%>
                                                          <ul class="row list-unstyled px-0 border border-secondary">
                                                            <% let orgsConnected=orgs.filter(el=> { %>
                                                              <%return currUser.contactConfirm.indexOf(el._id)> -1 %>
                                                                <%})%>
                                                                  <h5>You are connected with the following group(s):
                                                                  </h5>
                                                                  <ul>
                                                                    <% orgsConnected.forEach( el=> {%>
                                                                      <h3>
                                                                        <%= el.orgName%>
                                                                      </h3>
                                                                      <h4>
                                                                        <%= `${el.givenName} ${el.surName}`%>
                                                                      </h4>
                                                                      <h4>
                                                                        <%= `${el.email}`%>
                                                                      </h4>
                                                                              <% }) %>
                                                                  </ul>

                                                          </ul>
                                                          <%} else {%>
                                                            <ul>
                                                              <h5>You aren't connected to any ensembles.</h5>
                                                            </ul>
                                                            <% } %>
                                                          </div>
                                                            <div class="w-75 px-5">
                                                              <% if (postsVirginal.length) {%>
                                                                <h2>Available postings:</h2>
                                                                <!--unanswered postings-->
                                                                <ul class="list-group">
                                                                  <% for(var i=0; i<postsVirginal.length; i++) {%>
                                                                    <% let orgInfo=orgs.find( el=> {%>
                                                                      <% return `${el._id}`==`${postsVirginal[i].user}`})%>
                                                                        <li class="list-group-item">
                                                                          <h2 class="display-6">
                                                                            <%= postsVirginal[i].title %>
                                                                          </h2>
                                                                          <h3>
                                                                            <%= orgInfo.orgName %>
                                                                          </h3>
                                                                          <h3>
                                                                            <%= `${orgInfo.city}, ${orgInfo.loc_state}` %>
                                                                          </h3>
                                                                          <h3>

                                                                            <%= postsVirginal[i].description %>
                                                                          </h3>
                                                                          
                                                                          <% if (currUser.contactPending.indexOf(orgInfo._id) == -1){ %>
                                                                            <form class="col-1"
                                                                            action="/post/requestConnect/<%= postsVirginal[i].user %>/<%= currUser._id %>/?_method=PUT"
                                                                            method="POST">
                                                                            <button class="btn btn-primary"
                                                                              type="submit">
                                                                              <%= orgInfo.contactPending.indexOf(currUser._id) == -1 ? 'Connect' : 'Pending Request' %>
                                                                            </button>
                                                                          </form>
                                                                            <%} else { %>
                                                                            <form class="col-1"
                                                                                action="/connections/confirmConnect/<%= postsVirginal[i].user %>/<%= currUser._id %>/?_method=PUT"
                                                                                method="POST">
                                                                                <button class="btn btn-primary" type="submit">Accept</button>
                                                                              </form>
                                                                            <% }%>
                                                                        </li>
                                                                        <% } %>
                                                                </ul>
                                                                <%} else {%>
                                                                  <h2>No postings to display. Check back later!</h2>
                                                                  <% } %>

                                                                </div>

                                                              </div>

                                                                    <% } %>
        
      </div>
      <%- include('partials/footer') -%>